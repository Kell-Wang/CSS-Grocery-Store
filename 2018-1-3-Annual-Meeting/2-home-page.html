<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="keywords" content="">
    <meta name="description" content="">
    <title>2-主页</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta content="telephone=no,email=no" name="format-detection">
    <meta content="yes" name="apple-mobile-web-app-capable">
    <meta content="black" name="apple-mobile-web-app-status-bar-style">

    <link rel="stylesheet" href="static/css/bootstrap.css">
    <link rel="stylesheet" href="static/css/reset.css">
    <link rel="stylesheet" href="static/css/global.css">
    <link rel="stylesheet" href="static/css/barrage.css">

    <script type="text/javascript" src="static/js/jquery.min.js"></script>
    <script type="text/javascript" src="static/js/scrollreveal/scrollreveal.min.js"></script>
    <script type="text/javascript" src="static/js/global-functions-new.js"></script>
    <script type="text/javascript" src="static/js/barrage.js"></script>
    <script type="text/javascript" src="static/js/barrage-json.js"></script>
    <script type="text/javascript">
        // 加载scrollReveal
        (function(){
            window.sr = ScrollReveal();
        }());
    </script>

    <style type="text/css">
        .wall { position: relative; }
        .container { margin-top:14%; }

        h1 {
            text-align:center; font-size:108px;
            letter-spacing:13px;
        }

        /* 左侧按钮 */
        .side-left > .history-record {
            width:100%; height:185px;
            padding-top:.8em;
            margin-bottom:1em;
            cursor:pointer;
        }
        .history-default-bg {
            background:url("static/img/side-button-bg-lg1.png") no-repeat center;
            color:#c30f23;
        }
        .history-bg-hover {
            background:url("static/img/side-button-bg-lg-hover.png") no-repeat center;
            color:#fff;
        }

        /* 中间奖项 */
        .awards-btn {
            display:block; overflow:hidden;
            font-size:50px;  color:#ffffff;
            text-shadow:0 2px 4px rgba(0,0,0,0.50);
            margin:0 auto; line-height:106px;
            text-align:center;
            width:435px; height:105px;
        }
        .img-default-bg { background:url("static/img/button-bg-lg.png") no-repeat center; }
        .img-hover-bg { background:url("static/img/button-bg-lg-hover.png") no-repeat center; }
        .row { margin-bottom:8em; }

    </style>
</head>

<body>

    <!--绝对定位背景大图-->
    <div class="absolute-bg">
        <img src="static/img/bg.png" alt="">
    </div>


    <!-- 弹幕 barrage /'bærɑːʒ/ n.弹幕 -->
    <div class="barrage-container">
        <!-- first line -- 第1行 -->
        <div class="line1-wall every-line-wall"></div>
        <!-- second line -- 第2行 -->
        <div class="line2-wall every-line-wall"></div>
        <!-- third line -- 第3行 -->
        <div class="line3-wall every-line-wall"></div>
        <!-- fourth line -- 第4行 -->
        <div class="line4-wall every-line-wall"></div>
    </div>


    <!--绝对定位背景大图-->
    <div class="absolute-bg">
        <img src="static/img/bg.png" alt="">
    </div>

    <!--左侧竖排按钮-->
    <div class="side-left">
        <p class="history-record history-default-bg">历史记录</p>
        <p class="switch-btn switch-btn-default-bg">关</p>
    </div>

    <div class="container">

        <h1 class="font-tips">留言幸运奖</h1>

        <div class="row">
            <p class="col-lg-6 col-md-6">
                <a href="javascript:">
                    <span class="awards-btn img-default-bg">一等奖</span>
                </a>
            </p>
            <p class="col-lg-6 col-md-6">
                <a href="javascript:">
                    <span class="awards-btn img-default-bg">二等奖</span>
                </a>
            </p>
        </div>
        <div class="row">
            <p class="col-lg-6 col-md-6">
                <a href="javascript:">
                    <span class="awards-btn img-default-bg">三等奖</span>
                </a>
            </p>
            <p class="col-lg-6 col-md-6">
                <a href="javascript:">
                    <span class="awards-btn img-default-bg">留言幸运奖</span>
                </a>
            </p>
        </div>


    </div>


    <script type="text/javascript">

        // 元素配置表: 缓存静态html元素
        var eleConfMap = {

            // 弹幕
            brgContainer:       getClassName("barrage-container")[0],
            line1Wall:          getClassName("line1-wall")[0],
            line2Wall:          getClassName("line2-wall")[0],
            line3Wall:          getClassName("line3-wall")[0],
            line4Wall:          getClassName("line4-wall")[0],

            // 左侧边2个按钮
            $historyRecord:     $(".history-record"),
            $switchBtn:         $(".switch-btn"),

            // 中间奖项按钮
            $awardsBtn:         $(".awards-btn")
        };


        // ajax 配置图
        var ajaxMap = {

            // 按固定间隔时间读取数据
            ajaxGetJson:        function () {
                var getJson = null;
                $.ajax({
                    url:'https://m.dinpay.com:8443/annualMeeting/showBarrage.htm',
                    type:'post',
                    data:null,
                    async : false, // false 同步
                    error:function(){ },
                    success:function(data){
                        getJson = data;
                        console.log(data);
                    }
                });
                return getJson;
            }

        };



        window.onload = function(){


            // 弹幕
            (function () {
                var dataLength = null;

                var n = 0;
                var num = 0;
                function twenty () {
                    if ( n < 40) {
                        n++;
                        barrage();
                        setTimeout(twenty, 2000);
                    }
                }
                twenty();



                // 弹幕主函数: 1.创建弹幕。 2.滚动
                function barrage() {
                    var json = brgJson;
                    var i = 0,
                        len = json.length;
                    dataLength = len;

                    // 输出数据的长度
                    // console.log("输出数据的长度 " + dataLength);

                    // num +1
                    // console.log("Ajax调用次数 " + num++);


                    var numPlus = num++;
                    var arr = [];
                    var fragment;
                    if (len > 0) {

                        // 创建弹幕 div
                        for (; i < len; i++) {
                            if (i % 4 === 1) {
                                // 创建元素
                                fragment = mainMap.fnCreateEle(numPlus, i, json[i]);
                                eleConfMap.line1Wall.appendChild(fragment);

                                // 滚动弹幕: 第一行:
                                var aLin1DIV = getClassName("barrage-div", eleConfMap.line1Wall);
                                mainMap.fnScroll(600, aLin1DIV);

                                var c = 0,
                                    aLin1Len = aLin1DIV.length;

                                for (; c < aLin1Len; c++) {

                                    var ajaxNum = aLin1DIV[c].getAttribute("data-ajax-num");
                                    var index = parseInt(ajaxNum, 10) - 3;
                                    if (index >= 0) {
                                        var text = "all 0s ease 0s";
                                        var transition = getCss("transition", aLin1DIV[c]);
                                        if (transition !== text ||  transition !== "") {
                                            if (aLin1DIV[index].getAttribute("data-over-flag") == 1) {
                                                arr.push(aLin1DIV[index]);
                                            }
                                        }
                                    }
                                }

                                console.log(arr);
                                // 删除执行完的弹幕
                                /*var e = 0,
                                    arrLength = arr.length;
                                for (; e < arrLength; e++) {
                                    eleConfMap.line1Wall.removeChild(arr[e]);
                                }*/

                            }
                            if (i % 4 === 2) {
                                // 创建元素
                                fragment = mainMap.fnCreateEle(numPlus, i, json[i]);
                                eleConfMap.line2Wall.appendChild(fragment);

                                // 滚动弹幕: 第二行
                                var aLin2DIV = getClassName("barrage-div", eleConfMap.line2Wall);
                                mainMap.fnScroll(400, aLin2DIV);
                            }
                            if (i % 4 === 3) {
                                // 创建元素
                                fragment = mainMap.fnCreateEle(numPlus, i, json[i]);
                                eleConfMap.line3Wall.appendChild(fragment);

                                // 滚动弹幕: 第三行
                                var aLin3DIV = getClassName("barrage-div", eleConfMap.line3Wall);
                                mainMap.fnScroll(500, aLin3DIV);
                            }
                            if (i % 4 === 0) {
                                // 创建元素
                                fragment = mainMap.fnCreateEle(numPlus, i, json[i]);
                                eleConfMap.line4Wall.appendChild(fragment);

                                // 滚动弹幕: 第四行
                                var aLin4DIV = getClassName("barrage-div", eleConfMap.line4Wall);
                                mainMap.fnScroll(200, aLin4DIV);

                            }
                        }



                        // 创建完之后清除当前 json 数据
                        json = null;

                        // 每1000条清楚一次
                        // mainMap.fnClear(eleConfMap.line1Wall, eleConfMap.line2Wall, eleConfMap.line3Wall, eleConfMap.line4Wall);
                    }

                    // connection(dataLength);

                }

                // connection 连接 barrage 主函数和ajax返回条数确定不同调用时间的连接函数
                function connection(dataLength) {
                    dataLength = dataLength || 0;
                    if (dataLength === 0) {
                        equalZero();
                    }

                    if (dataLength > 0 && dataLength < 50) {
                        less50(dataLength)
                    }

                    if (dataLength >= 50 && dataLength <= 100) {
                        less100(dataLength);
                    }
                }


                var num1 = 0;
                var num2 = 0;
                var num3 = 0;

                function equalZero() {
                    setTimeout(function () {
                        console.log("equalZero num1 " + num1++);
                        barrage();
                    }, 6000);
                }

                function less50(dataLength) {
                    setTimeout(function () {
                        console.log("largeZero num2 " + num2++);
                        barrage();
                    }, dataLength * 5 * 100);
                }

                function less100(dataLength) {
                    setTimeout(function () {
                        console.log("largeZero num3 " + num3++);
                        barrage();
                    }, dataLength * 3 * 100);
                }


                // 弹幕开关
                eleConfMap.$switchBtn.click(function () {
                    if (Number(eleConfMap.brgContainer.style.zIndex) === -20) {
                        eleConfMap.brgContainer.style.zIndex = "10";
                    } else {
                        eleConfMap.brgContainer.style.zIndex = "-20";
                    }
                })

            })();


            // 左侧 + 中部 + 右侧
            (function (){
                var i = 0,
                    len =eleConfMap.$awardsBtn.length;
                for (; i < len; i++) {
                    if(i < 2){
                        sr.reveal(eleConfMap.$awardsBtn[i], {
                            origin:     "bottom",
                            distance:   "80px",
                            opacity:    0,
                            scale:      1,
                            delay:      200,
                            easing:     "ease",
                            reset:      false,
                            mobile:     true,
                            duration:   600
                        });
                    } else {
                        sr.reveal(eleConfMap.$awardsBtn[i], {
                            origin:     "bottom",
                            distance:   "80px",
                            opacity:    0,
                            scale:      1,
                            delay:      600,
                            easing:     "ease",
                            reset:      false,
                            mobile:     true,
                            duration:   600
                        });
                    }
                }

                // 4个奖项按钮hover效果
                eleConfMap.$awardsBtn.each(function(){
                    $(this).hover(
                        function () {
                            if($(this).hasClass("img-default-bg")){
                                $(this).removeClass("img-default-bg").addClass("img-hover-bg");
                            } else {
                                $(this).removeClass("img-hover-bg").addClass("img-default-bg");
                            }
                        }
                    )
                });


                // 左侧"历史记录"
                eleConfMap.$historyRecord.click(function () {
                    if($(this).hasClass("history-default-bg")){
                        $(this).removeClass("history-default-bg").addClass("history-bg-hover");
                    } else {
                        $(this).removeClass("history-bg-hover").addClass("history-default-bg");
                    }
                });


                // 左侧弹幕开关按钮hover效果
                eleConfMap.$switchBtn.click(function () {
                    if($(this).hasClass("switch-btn-default-bg")){
                        $(this).removeClass("switch-btn-default-bg").addClass("switch-btn-bg-hover");
                        $(this).html("开");
                    } else {
                        $(this).removeClass("switch-btn-bg-hover").addClass("switch-btn-default-bg");
                        $(this).html("关");
                    }
                });
            })();
        }
    </script>
</body>
</html>